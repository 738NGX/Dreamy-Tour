<wxs module="util" src="../../utils/util.wxs"></wxs>
<!-- 位置选择弹窗 -->
<t-popup-headered visible="{{mapVisible}}" title="选择位置" bind:visible-change="onMapVisibleChange" bindConfirm="changeLocation" bindCancel="onMapVisibleChange" placement="bottom" style="height: 50vh;">
  <map style="width:100%;height:500rpx;" latitude="{{mapLocation[0]}}" longitude="{{mapLocation[1]}}" markers="{{markers}}" />
  <view class="column" style="width:90%;">当前位置:{{mapLocation[0]}},{{mapLocation[1]}}</view>
</t-popup-headered>
<!-- 查看消费弹窗 -->
<t-popup-headered visible="{{expenseVisible}}" title="查看消费" bind:visible-change="onExpenseVisibleChange" bindConfirm="changeExpense" bindCancel="onExpenseVisibleChange" placement="bottom" style="height: 80vh;">
  <scroll-view class="scrollarea" scroll-y type="list" style="height: 70vh;">
    <view class="container" style="padding:0;justify-content:flex-start;">
      <t-collapse value="{{[editingExpenseId]}}" bind:change="onExpenseIdChange" expandMutex expandIcon>
        <block wx:for="{{editingLocation.expenses}}" wx:key="index" wx:for-index="i">
          <t-swipe-cell>
            <t-collapse-panel header="{{item.title}}" headerRightContent="{{item.amount}}{{currencyList[item.currency].symbol}}" value="{{i}}">
              <t-icon prefix="iconfont" name="{{expenseList[item.type].icon}}" size="32rpx" slot="header-left-icon" />
              <t-input label="标题" placeholder="请输入标题" value="{{item.title}}" maxcharacter="{{40}}" bind:change="onExpenseTitleInput" />
              <t-input label="费用" placeholder="0.00" align="right" type="digit" value="{{item.amount}}" bind:change="onExpensePriceInput" tips="{{priceError ? '请输入正确的费用' : ''}}" t-class-tips="tips">
                <t-button size="large" theme="primary" variant="outline" bind:tap="exchangeExpenseCurrency" style="height:50rpx;" slot="suffix">{{currencyList[item.currency].symbol}}</t-button>
              </t-input>
              <t-radio-group value="{{item.type}}" borderless t-class="box2" bind:change="handleExpenseTypeChange">
                <block wx:for="{{expenseList}}" wx:key="label">
                  <t-radio value="{{item.value}}">
                    <view class="row" style="margin:0" slot="label">
                      <t-icon prefix="iconfont" name="{{item.icon}}" size="32rpx" style="margin:0 10rpx;" />
                      {{item.label}}
                    </view>
                  </t-radio>
                </block>
              </t-radio-group>
              <t-radio-group t-class="horizontal-box" value="{{item.tag}}" bind:change="onExpenseTagChange">
                <view wx:for="{{tagList}}" wx:key="index" wx:for-index="j" class="card {{editingLocation.expenses[i].tag == j ? 'card--active' : ''}}" style="background-color: \#{{item.color}};">
                  <t-icon wx:if="{{editingLocation.expenses[i].tag == j}}" name="check" t-class="card__icon" />
                  <t-radio value="{{item.value}}" label="{{j}}" icon="none" style="background-color: \#{{item.color}};" borderless />
                </view>
              </t-radio-group>
              <t-textarea disabled placeholder="备注最多输入500个字" maxlength="500" disableDefaultPadding="{{true}}" value="{{item.note}}" bind:change="onExpenseNoteInput" indicator />
            </t-collapse-panel>
            <view slot="right" class="btn2 delete-btn" bind:tap="removeExpense" data-index="{{i}}">删除</view>
          </t-swipe-cell>
        </block>
      </t-collapse>
    </view>
  </scroll-view>
</t-popup-headered>
<!-- 查看备注弹窗 -->
<t-popup-headered visible="{{noteVisible}}" title="查看备注" bind:visible-change="onNoteVisibleChange" bindConfirm="changeNote" bindCancel="onNoteVisibleChange" placement="bottom" style="height: 30vh;">
  <t-textarea style="height: 100%;" placeholder="备注最多输入500个字" maxlength="500" disableDefaultPadding="{{true}}" value="{{editingNote}}" bind:change="onNoteInput" indicator />
</t-popup-headered>
<!-- 查看交通消费弹窗 -->
<t-popup-headered visible="{{transExpenseVisible}}" title="查看交通" bind:visible-change="onTransExpenseVisibleChange" bindConfirm="onTransExpenseVisibleChange" bindCancel="onTransExpenseVisibleChange" placement="bottom" style="height: 60vh;">
  <t-input disabled label="标题" value="{{editingTransExpense.title}}" maxcharacter="{{40}}" bind:change="onTransExpenseTitleInput" />
  <t-input disabled label="费用" align="right" type="digit" value="{{editingTransExpense.amount}}" bind:change="onTransExpensePriceInput" tips="{{priceError ? '请输入正确的费用' : ''}}" t-class-tips="tips">
    <t-button disabled size="large" theme="primary" variant="outline" style="height:50rpx;" slot="suffix">{{currencyList[editingTransExpense.currency].symbol}}</t-button>
  </t-input>
  <t-radio-group value="{{editingTransExpense.transportType}}" borderless t-class="box" bind:change="handleTransExpenseTypeChange">
    <block wx:for="{{transportList}}" wx:key="label">
      <t-radio class="radio" disabled value="{{item.value}}">
        <view class="row" style="margin:0" slot="label">
          <t-icon prefix="iconfont" name="{{item.icon}}" size="32rpx" style="margin:0 10rpx;" />
          {{item.label}}
        </view>
      </t-radio>
    </block>
  </t-radio-group>
  <t-textarea disabled maxlength="500" disableDefaultPadding="{{true}}" value="{{editingTransExpense.note}}" bind:change="onTransExpenseNoteInput" indicator />
</t-popup-headered>
<!-- 节点显示 -->
<view class="container" style="align-items: center;">
  <view wx:if="{{util.isInArray(displayingLocationId,0)}}" class="location">
    <t-cell title="{{currentTour.locations[0].title}}" />
    <view class="row">
      <t-icon name="flight-takeoff" size="32rpx" style="margin:0 10rpx;" />
      <view style="width: 90%;">开始时间:{{currentStartDateStrList[0]}}</view>
      <t-button disabled size="large" theme="primary" variant="outline" style="width: 10%;height: 50rpx;" bind:tap="handleNodeStartDateSelect" data-index="{{0}}">调整</t-button>
    </view>
    <view class="row">
      <t-icon name="flight-landing" size="32rpx" style="margin:0 10rpx;" />
      <view style="width: 90%;">结束时间:{{currentEndDateStrList[0]}}</view>
      <t-button disabled size="large" theme="primary" variant="outline" style="width: 10%;height: 50rpx;" bind:tap="handleNodeEndDateSelect" data-index="{{0}}">调整</t-button>
    </view>
    <view class="row">
      <t-icon name="time" size="32rpx" style="margin:0 10rpx;" />
      <view style="width: 90%;">时区:{{currentTimezoneStrList[0]}}</view>
      <t-button disabled size="large" theme="primary" variant="outline" style="width: 10%;height: 50rpx;" bind:tap="handleNodeTimezoneSelect" data-index="{{0}}">选择</t-button>
    </view>
    <view class="row">
      <t-icon name="location" size="32rpx" style="margin:0 10rpx;" />
      <view style="width: 90%;">位置:{{currentTour.locations[0].latitude}},{{currentTour.locations[0].longitude}}</view>
      <t-button size="large" theme="primary" variant="outline" style="width: 10%;height: 50rpx;" bind:tap="onMapVisibleChange" data-index="{{0}}">查看</t-button>
    </view>
    <view class="row">
      <t-button size="large" theme="primary" variant="outline" style="width: 49%;height: 50rpx;" bind:tap="onExpenseVisibleChange" data-index="{{0}}">查看消费</t-button>
      <t-button size="large" theme="primary" variant="outline" style="width: 49%;height: 50rpx;" bind:tap="onNoteVisibleChange" data-index="{{0}}">查看备注</t-button>
    </view>
  </view>
  <!-- 遍历节点 -->
  <block wx:if="{{util.isInArray(displayingTransportationId,i)}}" wx:for="{{currentTour.transportations}}" wx:key="index" wx:for-index="i">
    <view class="connecter" />
    <view class="transportation">
      <view class="row">
        <t-icon name="time" size="32rpx" style="margin:0 10rpx;" />
        <view style="width:90%;">交通时长:{{currentDurationStrList[i]}}</view>
        <t-button disabled size="large" theme="primary" variant="outline" style="width: 10%;height: 50rpx;" bind:tap="handleDuartionSelect" data-index="{{i}}">调整</t-button>
      </view>
      <block wx:for="{{item.transportExpenses}}" wx:key="index" wx:for-index="j">
        <t-swipe-cell>
          <t-cell class="transexpensecell" bordered="{{false}}">
            <view class="row" style="margin:0;" slot="left-icon">
              <t-icon prefix="iconfont" name="{{transiconList[item.transportType]}}" size="32rpx" style="margin:0 10rpx;" />
              {{item.title}}
            </view>
            <view style="display:flex;justify-content:space-between;" slot="right-icon">
              <view style="width:90%;" />
              <t-button size="large" theme="primary" variant="outline" bind:tap="onTransExpenseVisibleChange" style="height:50rpx;width:10%;margin-left:auto;" data-index="{{[i,j]}}">查看</t-button>
            </view>
          </t-cell>
        </t-swipe-cell>
      </block>
    </view>
    <view wx:if="{{util.isInArray(displayingLocationId,i+1)}}" class="connecter" />
    <view wx:if="{{util.isInArray(displayingLocationId,i+1)}}" class="location">
      <t-cell title="{{currentTour.locations[i+1].title}}" />
      <view class="row">
        <t-icon name="flight-takeoff" size="32rpx" style="margin:0 10rpx;" />
        <view style="width: 90%;">开始时间:{{currentStartDateStrList[i+1]}}</view>
        <t-button disabled size="large" theme="primary" variant="outline" style="width: 10%;height: 50rpx;" bind:tap="handleNodeStartDateSelect" data-index="{{i+1}}">调整</t-button>
      </view>
      <view class="row">
        <t-icon name="flight-landing" size="32rpx" style="margin:0 10rpx;" />
        <view style="width: 90%;">结束时间:{{currentEndDateStrList[i+1]}}</view>
        <t-button disabled size="large" theme="primary" variant="outline" style="width: 10%;height: 50rpx;" bind:tap="handleNodeEndDateSelect" data-index="{{i+1}}">调整</t-button>
      </view>
      <view class="row">
        <t-icon name="time" size="32rpx" style="margin:0 10rpx;" />
        <view style="width: 90%;">时区:{{currentTimezoneStrList[i+1]}}</view>
        <t-button disabled size="large" theme="primary" variant="outline" style="width: 10%;height: 50rpx;" bind:tap="handleNodeTimezoneSelect" data-index="{{i+1}}">选择</t-button>
      </view>
      <view class="row">
        <t-icon name="location" size="32rpx" style="margin:0 10rpx;" />
        <view style="width: 90%;">位置:{{currentTour.locations[i+1].latitude}},{{currentTour.locations[i+1].longitude}}</view>
        <t-button size="large" theme="primary" variant="outline" style="width: 10%;height: 50rpx;" bind:tap="onMapVisibleChange" data-index="{{i+1}}">查看</t-button>
      </view>
      <view class="row">
        <t-button size="large" theme="primary" variant="outline" style="width: 49%;height: 50rpx;" bind:tap="onExpenseVisibleChange" data-index="{{i+1}}">查看消费</t-button>
        <t-button size="large" theme="primary" variant="outline" style="width: 49%;height: 50rpx;" bind:tap="onNoteVisibleChange" data-index="{{i+1}}">查看备注</t-button>
      </view>
    </view>
  </block>
</view>